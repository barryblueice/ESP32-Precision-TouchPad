#include <stdint.h>

typedef struct {
    uint32_t send_count;
    char message[16];
} __attribute__((packed)) test_packet_t;

#define ESPNOW_CHANNEL 1

#include <stdio.h>
#include <string.h>
#include "nvs_flash.h"
#include "esp_wifi.h"
#include "esp_now.h"
#include "esp_log.h"

static const char *TAG = "Reciever";

static void recv_cb(const esp_now_recv_info_t *recv_info, const uint8_t *data, int len) {
    test_packet_t pkt;
    if (len == sizeof(test_packet_t)) {
        memcpy(&pkt, data, sizeof(pkt));
        int rssi = recv_info->rx_ctrl->rssi;
        printf("Pkt: %u | RSSI: %d dBm\r\n", (unsigned int)pkt.send_count, recv_info->rx_ctrl->rssi);
    }
}

void app_main(void) {
    ESP_ERROR_CHECK(nvs_flash_init());
    ESP_ERROR_CHECK(esp_netif_init());
    ESP_ERROR_CHECK(esp_event_loop_create_default());
    wifi_init_config_t cfg = WIFI_INIT_CONFIG_DEFAULT();
    ESP_ERROR_CHECK(esp_wifi_init(&cfg));
    ESP_ERROR_CHECK(esp_wifi_set_mode(WIFI_MODE_STA));
    ESP_ERROR_CHECK(esp_wifi_start());

    ESP_ERROR_CHECK(esp_now_init());
    ESP_ERROR_CHECK(esp_now_register_recv_cb(recv_cb));

    ESP_LOGI(TAG, "RSSI Receiver started on Native USB...");
}